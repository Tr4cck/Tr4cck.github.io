---
title: ã€ŒSECCONCTF2021ã€Rev | æ±‡ç¼–è°ƒè¯•ä¸é©¬å°”å¯å¤«å›¾çµæœº
date: 2022-01-13 19:01:15
tags:
- Rev
categories:
- TECHNOLOGY
---

## pyast64++.rev

é¢˜ç›®å®ç°äº†ä¸€ä¸ªç®€å•çš„ py æ±‡ç¼–å™¨ã€‚å°†å¯æ‰§è¡Œæ–‡ä»¶æ‹–è¿› IDA å¯ä»¥çœ‹åˆ°éå¸¸å¤šæˆå¯¹çš„ push-pop æ“ä½œï¼Œå¹¶ä¸”ç®€å•è°ƒè¯•ä¸€ä¸‹å‘ç°å‡½æ•°è°ƒç”¨æ ˆæ˜¯ä¸€ç§å¥‡æ€ªçš„ç»“æ„ï¼Œå³ï¼š

```
--------
|length|
--------
|canary|
--------
|param1|
--------
|param2|
........
```

çŒœæµ‹å‡ºé¢˜äººæ²¡æœ‰å¯¹ç¼–è¯‘å‡ºæ¥çš„æ±‡ç¼–ä»£ç åšä¼˜åŒ–ï¼Œå‡½æ•°å®ç°ã€ä¼ å‚ä»¥åŠç”¨äºæ ˆä¿æŠ¤çš„ canary ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒåŸå§‹çš„å®ç°ã€‚å¤§æ¦‚æœ‰ä¸¤ç§æ€è·¯ï¼š

- åˆ†æé™„ä»¶ç»™å‡ºçš„ pyï¼Œå†™æ±‡ç¼–å™¨çš„æ¢å¤
- ç›´æ¥é€†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”è¾ƒè€—æ—¶ä½†åº”è¯¥å¯åš

æ¯”èµ›æ—¶é€‰æ‹©äº†åè€…ï¼Œå› ä¸ºè§‰å¾—æ˜¯ä¸€ç§æ¯”è¾ƒå¥½ä¸Šæ‰‹çš„æ€è·¯ï¼Œåé¢å¯ä»¥ç ”ç©¶è¿™ä¸ªæ±‡ç¼–å™¨çš„å®ç°ï¼Œçœ‹çœ‹èƒ½å¦æ¢å¤å‡ºæŠ½è±¡è¯­æ³•æ ‘ã€‚

ç¨‹åºæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

```
read flag -> check -> compare
```

æ¯”è¾ƒå¥—è·¯åŒ–çš„è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯è°ƒè¯•çš„æ—¶å€™ç”±äºèµ‹å€¼æ˜¯é€šè¿‡ push-pop å¯¹ï¼Œæ¯”è¾ƒè€—æ—¶è€—åŠ›ã€‚ç„¶åç”±äºæ ˆç»“æ„çš„å˜åŒ–ï¼Œä½¿å¾— IDA çš„ F5 åŸºæœ¬æ˜¯ä¸èƒ½ç»†çœ‹ï¼Œæ¨èä¸»è¦çœ‹æ±‡ç¼–ï¼Œä¸å¤ªæ˜ç™½çš„åœ°æ–¹ F5 å‚è€ƒä¸€ä¸‹ã€‚ä»£ç æ¢å¤ç»“æœï¼š

```python
S = []
T = []
NEW = [0] * 64
key = 'SECCON2021'
sec_to_plain = [0x61] * 40
for i in range(256):
    S.append(255 - i)
    T.append(ord(key[i % len(key)]))

j = 0
for i in range(256):
    j = (j + S[i] + T[i]) % 256
    (S[i], S[j]) = (S[j], S[i])

for cnt in range(10):
    # S
    for i in range(64):
        sec_to_plain[i] = S[sec_to_plain[i]]

    # P
    for i in range(8):
        for j in range(8):
            tmp = sec_to_plain[8*i + j]
            for k in range(8): # äºŒè¿›åˆ¶ç¼–ç 
                NEW[k + 8 * j] = tmp % 2
                tmp //= 2
        for j in range(64):
            res = (j * j * j )% 0x43 % 0x40 # æ¯”ç‰¹äº¤æ¢
            (NEW[res], NEW[j]) = (NEW[j], NEW[res])
        for j in range(8): # äºŒè¿›åˆ¶è¯‘ç 
            v78 = 0
            v74 = 1
            for k in range(8):
               v78 |= NEW[k + 8 * j] * v74
               v74 *= 2
            v70 = j + 8 * i
            sec_to_plain[v70] = v78

    for i in range(64):
        sec_to_plain[i] ^= ord(key[cnt])

enc = [0x4B, 0xCB, 0xBE, 0x7E, 0xB8, 0xA9, 0x1B, 0x4A, 0x23, 0x53, 0x71, 0x41, 0xCF, 0xC1, 0x1B, 0x89, 0x25, 0x62, 0x00, 0x44, 0xDB, 0x71, 0x15, 0xB4, 0xDF, 0x87, 0x05, 0x81, 0xBD, 0xC8, 0xF5, 0x64, 0x75, 0x3E, 0xC0, 0x65, 0xEF, 0x5C, 0xB6, 0x88, 0x9F, 0xEB, 0xA6, 0x5A, 0x4A, 0x85, 0x53, 0x4E, 0x06, 0xE1, 0x65, 0x67, 0x52, 0x4E, 0x90, 0xCD, 0x82, 0xEE, 0xAF, 0xF5, 0xAC, 0x3E, 0x9D, 0xB0]
```

expï¼š

```python
ans = []
S = [243, 106, 132, 232, 161, 31, 46, 140, 221, 19, 203, 158, 173, 183, 157, 76, 43, 237, 13, 209, 130, 81, 39, 235, 198, 122, 123, 77, 62, 63, 79, 146, 196, 215, 93, 145, 38, 187, 2, 14, 163, 195, 171, 242, 178, 167, 164, 236, 220, 212, 102, 3, 162, 192, 168, 230, 153, 252, 124, 229, 210, 159, 71, 45, 34, 6, 127, 84, 143, 113, 57, 96, 66, 100, 44, 204, 30, 87, 250, 185, 118, 131, 65, 47, 174, 54, 24, 98, 137, 213, 69, 52, 223, 110, 129, 255, 75, 53, 99, 36, 58, 197, 251, 175, 244, 51, 21, 217, 211, 169, 201, 141, 234, 83, 16, 49, 12, 92, 1, 166, 8, 206, 186, 126, 239, 240, 108, 29, 144, 194, 238, 105, 120, 224, 179, 32, 119, 228, 138, 231, 125, 26, 165, 133, 73, 40, 107, 249, 227, 248, 74, 176, 184, 20, 10, 116, 78, 80, 111, 60, 155, 104, 41, 68, 33, 142, 112, 59, 136, 149, 85, 128, 48, 177, 0, 150, 241, 94, 72, 160, 253, 139, 135, 154, 56, 233, 7, 11, 28, 202, 172, 27, 50, 82, 246, 193, 205, 22, 200, 247, 9, 208, 216, 115, 121, 189, 190, 134, 218, 152, 219, 5, 15, 86, 61, 23, 188, 35, 117, 88, 151, 4, 70, 207, 89, 180, 222, 214, 55, 245, 156, 91, 226, 254, 191, 181, 182, 148, 170, 225, 199, 97, 67, 101, 64, 103, 114, 25, 147, 18, 95, 42, 37, 17, 109, 90]
enc = [0x4B, 0xCB, 0xBE, 0x7E, 0xB8, 0xA9, 0x1B, 0x4A, 0x23, 0x53, 0x71, 0x41, 0xCF, 0xC1, 0x1B, 0x89, 0x25, 0x62, 0x00, 0x44, 0xDB, 0x71, 0x15, 0xB4, 0xDF, 0x87, 0x05, 0x81, 0xBD, 0xC8, 0xF5, 0x64, 0x75, 0x3E, 0xC0, 0x65, 0xEF, 0x5C, 0xB6, 0x88, 0x9F, 0xEB, 0xA6, 0x5A, 0x4A, 0x85, 0x53, 0x4E, 0x06, 0xE1, 0x65, 0x67, 0x52, 0x4E, 0x90, 0xCD, 0x82, 0xEE, 0xAF, 0xF5, 0xAC, 0x3E, 0x9D, 0xB0]
key = 'SECCON2021'
NEW_SUB = [0] * 64

for cnt in range(10):
    for i in range(64):
        enc[i] ^= ord(key[10 - cnt - 1])

    for i in range(8):
        for j in range(8):
            tmp = enc[j + i*8]
            for k in range(8):
                NEW_SUB[k + 8*j] = tmp % 2
                tmp //= 2

        for j in range(63, -1, -1):
            res = (j**3) % 0x43 % 0x40
            NEW_SUB[res], NEW_SUB[j] = NEW_SUB[j], NEW_SUB[res]

        for j in range(8):
            v78 = 0
            v74 = 1
            for k in range(8):
                v78 |= NEW_SUB[k + 8*j] * v74
                v74 *= 2
            enc[j + 8*i] = v78

    for i in range(64):
        enc[i] = S.index(enc[i])


print(bytes(enc))
```

## sed-programming
é¢˜ç›®åˆ©ç”¨å®ç° sed å·¥å…·çš„æ ¸å¿ƒç®—æ³• markov-algorithm çš„å›¾çµå®Œå¤‡æ€§ï¼Œå®ç°äº†ä¸€é—¨ç¼–ç¨‹è¯­è¨€ã€‚ä¸‹é¢å…ˆæ¥äº†è§£ä¸€ä¸‹ markov-algorithmã€‚
### markov-algorithm
æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²é‡å†™ç³»ç»Ÿï¼Œæ•°å­¦ä¸Šè¢«è¯æ˜æ˜¯å›¾çµå®Œå¤‡çš„ï¼Œæ„å‘³ç€å¯ä»¥åŸºäºå®ƒå®ç°é€šç”¨è®¡ç®—æ¨¡å‹ã€æ•°å­¦è¡¨è¾¾å¼ã€ç¼–ç¨‹è¯­è¨€å®ç°ç­‰ã€‚å®ƒä¸»è¦ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šå¯åº”ç”¨çš„å­—æ¯è¡¨ + æ˜ å°„æ–¹æ³•é›†åˆ$\{D=f(L) | L \rarr D\}$ï¼Œå…¶ä¸­ L å’Œ D å‡è¡¨ç¤ºç”±å­—æ¯è¡¨ä¸­ç¬¦å·ç»„æˆçš„ä»»æ„çš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å‡è®¾ $\rarr$ ä¸å­˜åœ¨äºå­—æ¯è¡¨ä¸­ï¼Œå¦åˆ™éœ€è¦é‡æ–°æ‰¾ä¸€ä¸ªåˆ†å‰²å­—ç¬¦ä¸²ã€‚

ä¸¾ä¸ª ğŸŒ° æ–¹ä¾¿ç†è§£ï¼š

alphabet = {|, *, a, b, c}
$$
f = 
\begin{cases}
|b \rarr ba| \\
ab \rarr ba \\
b \rarr \\
*| \rarr b* \\
* \rarr c \\
|c \rarr c \\
ac \rarr c| \\
c \rarr .

\end{cases}
$$
å°†è¯¥ç®—æ³•åº”ç”¨å­—æ¯è¡¨ä¸­çš„ä»»æ„å­—ç¬¦ä¸² V çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªç¦»æ•£çš„åŸºæœ¬æ­¥éª¤åºåˆ—ã€‚æˆ‘ä»¬å‡è®¾ Vâ€² æ˜¯åœ¨ç®—æ³•çš„å‰ä¸€æ­¥ä¸­å¾—åˆ°çš„è¯ï¼ˆæˆ–è€…æ˜¯åŸå§‹è¯ Vï¼Œå¦‚æœå½“å‰çš„æ­¥éª¤æ˜¯ç¬¬ä¸€æ­¥ï¼‰ã€‚å¦‚æœæ›¿æ¢å…¬å¼ä¸­æ²¡æœ‰åŒ…å«åœ¨ Vâ€² ä¸­çš„å·¦æ‰‹è¾¹ï¼Œé‚£ä¹ˆç®—æ³•å°±ç»ˆæ­¢äº†ï¼Œå…¶å·¥ä½œç»“æœè¢«è®¤ä¸ºæ˜¯å­—ç¬¦ä¸² Vâ€²ã€‚å¦åˆ™ï¼Œå°†é€‰æ‹©å·¦æ‰‹è¾¹åŒ…å«åœ¨ Vâ€² ä¸­çš„ **ç¬¬ä¸€ä¸ª** æ›¿æ¢å…¬å¼ã€‚å¦‚æœè¿™ä¸ªæ›¿æ¢å…¬å¼çš„å½¢å¼æ˜¯ Lâ†’Dï¼Œé‚£ä¹ˆåœ¨R L Så½¢å¼çš„å­—ç¬¦ä¸² Vâ€² çš„æ‰€æœ‰å¯èƒ½çš„è¡¨ç¤ºä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªæœ€çŸ­çš„ Rï¼Œä¹‹åå­—ç¬¦ä¸²R D Sè¢«è®¤ä¸ºæ˜¯å½“å‰æ­¥éª¤çš„ç»“æœï¼Œéœ€è¦åœ¨ä¸‹ä¸€æ­¥éª¤ä¸­è¿›ä¸€æ­¥å¤„ç†ã€‚

æ¯”å¦‚ä¸Šé¢çš„ ğŸŒ° ï¼Œ|*|| çš„ç»“æœæ˜¯ || ï¼Œå¯ä»¥è‡ªå·±éªŒè¯ä¸€ä¸‹ã€‚

### sed

[info sed](https://www.gnu.org/software/sed/manual/sed.html)ï¼Œsed åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒæ­£åˆ™åŒ¹é…ï¼Œè¿™é“é¢˜ç”¨äº†ä¸‰ä¸ªï¼š

-   `s`ubstitute

-    `t`est. Jump if a substitution is done.
-   `p`rint. Print the result after every substitution.

æˆ‘ä»¬å¯ä»¥å…ˆä»åé¢å•ä¸ªå­—ç¬¦çš„æ›¿æ¢å¼€å§‹ï¼š

```
s/S/1IlIl11IIll11IlIl11IIll11IlIl11IlIl11IIll11IIll1/;tt
s/T/1IlIl11IIll11IlIl11IIll11IlIl11IIll11IlIl11IlIl1/;tt
s/i/1IlIl11IIll11IIll11IlIl11IIll11IlIl11IlIl11IIll1/;tt
s/7/1IlIl11IlIl11IIll11IIll11IlIl11IIll11IIll11IIll1/;tt
s/y/1IlIl11IIll11IIll11IIll11IIll11IlIl11IlIl11IIll1/;tt
s/b/1IlIl11IIll11IIll11IlIl11IlIl11IlIl11IIll11IlIl1/;tt
s/q/1IlIl11IIll11IIll11IIll11IlIl11IlIl11IlIl11IIll1/;tt
```

å‘ç°é•¿åº¦ä¸€è‡´ä¸”ä¸º 8 çš„å€æ•°ï¼ŒçŒœæµ‹æ˜¯ ascii codeã€‚å°è¯•å®šä¹‰æ˜ å°„é›†å¦‚ä¸‹ï¼š

```python
R = [
  ("1IlI1" , "#"),
  ("1I1"   , "-"),
  ("1IIlI1", "<"),
  ("1l1"   , ">"),
  ("1IllI1", "@"),
  ("1III1" , "a"),
  ("1IIII1", "b"),
  ("1IIIl1", "f"),
  ("1II1"  , "t"),
  ("1Ill1" , "x"),
  ("1Illl1", "y"),
  ("1IlIl1", "0"),
  ("1IIll1", "1"),
]

for line in open('checker/checker0.sed'):
  line = line[:-1]

  remove = False
  for _, v in R:
    if line.startswith(f"s/{v}/"): # avoid conflict
      remove = True
  if remove:
    line = "#"+line

  for k, v in R:
    line = line.replace(k, v)

  print(line)

  if line==":t":
    print("p") # log
```

å…¶å®å¯ä»¥éšä¾¿å®šï¼Œç„¶åå°±å¯ä»¥è¯»ä¸€ä¸‹å˜æ¢å‡ºæ¥çš„æºç ï¼Œå‘ç°ç¨‹åºæ˜¯åŸºäº cursor çš„ä¸€ç§å˜æ¢ï¼š

-   ç”Ÿæˆ cursorï¼Œç„¶åä¸åœåšç±»ä¼¼ rol çš„æ“ä½œ
-   æ¯ 3bit åˆ†ä¸ºä¸€ç»„ï¼Œå¹¶æ›¿æ¢æˆ count('1') % 2 ç„¶åé‡å¤ 0b1101 æ¬¡

ç”¨ python å…ˆæŠŠæ¯”è¾ƒæ•°æå–å‡ºæ¥ï¼Œæ€è·¯æ˜¯ä¸€ä¸ªæ­£åˆ™æ¯”è¾ƒï¼Œæ¯æ¬¡éƒ½ä» bin(n) å»æ‰¾ bin(n+1)ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ª t åé¢çš„ä¸€ä½å°±æ˜¯å¾…æ¯”è¾ƒçš„æ•°ï¼Œå¦‚ä¸‹ï¼š

```python
import re

r = re.compile(r"^s/t([01]+)t([01])/t[01]+t/;tt$")

target = {}
for line in open("checker/checker_unobfuscated.sed"):
  line = line[:-1]
  m = r.match(line)
  if m:
    target[int(m.group(1), 2)] = m.group(2) # just ()

print(target)
print("target:", "".join(target[k] for k in range(len(target))))
```

ç„¶å exp ç”±äºæŸäº›ä½å·²çŸ¥ï¼Œæ€è·¯ç±»ä¼¼ï¼š

```python
N = 13
target = "110101101111111011101100110001110111101011110100101101011011110011000101001001011111000101001011100000100101001111001111111011100100001001011100110010000011111101110110110100000111000010101101"
n = len(target)

flag = "SECCON{"+"X"*(n//8-8)+"}"
flag = "".join(bin(ord(f)+0x100).replace("0b1", "") for f in flag) # confirm character -> 8 bit binary

T = [list(flag)] # original flag with all 13 loops results
for i in range(N):
  t = ["0"]+T[i]+["0"]
  T += [[]]
  for j in range(n):
    T[i+1] += [str(t[j:j+3].count("1")%2)]
T[N] = list(target)

for i in range(N)[::-1]:
  for j in range(1, n-1):
    T[i][j+1] = str((T[i][j-1:j+1]+[T[i+1][j]]).count("1")%2)

flag = "".join(T[0])
flag = "".join(chr(int("".join(flag[i:i+8]), 2)) for i in range(0, n, 8))
print("flag:", flag)
```
